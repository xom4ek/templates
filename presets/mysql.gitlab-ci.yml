variables:
  REBUILD_MYSQL:
    value: "false"
    description: "If you want rebuild (TAKE A LONG TIME) mysql - set to trueðŸŒˆ"
  DROP_MYSQL:
    value: "false"
    description: "If you want drop mysql - set to trueðŸŒˆ"
  MIGRATE_COMMAND: python manage.py migrate --noinput
  MIGRATION_TARGET: api
rebuild-mysql:
  stage: build
  trigger:
    project: 'infra/mysql'
    strategy: depend
  rules:
    - if: '$REBUILD_MYSQL == "true"'

drop-mysql:
  image: $CI_TOOLS_REGISTRY/docker-compose
  stage: analyse
  allow_failure: true
  script:
    - docker-compose pull mysql || true
    - docker-compose stop mysql
    - docker-compose rm -f mysql
    - docker-compose up -d mysql
    - docker-compose exec -T $MIGRATION_TARGET sh -c "sleep 10 && $MIGRATE_COMMAND"
  rules:
    - if: '$DROP_MYSQL == "true"'
